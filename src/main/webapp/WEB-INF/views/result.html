
<!DOCTYPE html>
<html lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>搜索： '${currQ}' - NetEye</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
  <meta name="keyword" content="cyberspace,device,NetEye,fingerprint,security,search engine,ipv4,nmap,scan,web">
  <link rel="shortcut icon" href="static/images/favicon.ico">
  <link rel="search" type="application/opensearchdescription+xml" href="static/opensearch.xml" title="NetEye">

  <!--[if lte IE 8]><meta http-equiv="refresh" content="0;url=/ie" /><![endif]-->

  <link href="static/css/search.dist.v2_7.css" rel="stylesheet" type="text/css" media="screen">
  <link href="static/css/spinner.dist.v2_4.css" rel="stylesheet" type="text/css" media="screen">
  <link href="static/css/v3_to_v4_migrate.dist.v1_0_8.css" rel="stylesheet" type="text/css" media="screen">
  
  <script type="text/javascript" src="static/scripts/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="static/scripts/country_name2code.js"></script>
</head>

<body class="results" data-manual-ajax-url="help/manual_ajax">

<section class="mini-search affix-top" data-spy="affix" data-offset-top="0">
  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-11 col-lg-11">
        <a href="/" class="hidden-xs pull-left">
          <img class="logo-sm" src="static/images/neteye_small.png" data-retina="static/images/neteye.png" data-fallback="static/images/NetEye.png" style="width: 160px;height: 34px;">
        </a>
        <div class="bar">
          <form action="search" method="get" class="ultra-form">
            <input type="hidden" value="host" name="t">
            <span class="twitter-typeahead" style="position: relative; display: inline-block; direction: ltr;">
            	<input type="text" autocomplete="off" name="q" id="q"  value="${currQ}" class="flex-text tt-input" role="combobox" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
            	<pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; word-spacing: 0px; letter-spacing: 0px; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre>
            	<span class="tt-dropdown-menu" style="position: absolute; top: 100%; left: 0px; z-index: 100; display: none; right: auto;">
            	<div class="tt-dataset-app"></div></span></span><button class="btn btn-info default" type="submit">探索一下</button>
          </form>            	<input type="hidden" id="currQ" name="currQ" value="${currQ}"/>
        </div>
      </div>
      <div class="col-xs-1 col-lg-1">
        <ul class="nav navbar-nav">
        </ul>
          <ul class="nav navbar-nav navbar-right">
              <li><a href="">登录</a></li>
          </ul>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-12">
        <ul class="nav nav-tabs search-tab" role="navigation">
          <li data-nav="search" class="active">
            <a href="javascript:void(0)">搜索结果</a>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</section>


  <section class="search-results">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-12">

          <div class="aggregation">
            <h3 class="filter-title-result-type hidden-xs">搜索类型</h3>
            <ul class="bar-filter filter-result-type clearfix finished">
                <li class="clearfix active">
                  <a href="search?q=app%3A%22Indy%20httpd%22&amp;t=host&amp;f=fliter">公网设备</a>
                  <i class="glyphicon glyphicon-triangle-left"></i>
                </li>
                <li class="clearfix">
                  <a href="search?q=app%3A%22Indy%20httpd%22&amp;t=web&amp;f=fliter">Web 服务</a>
                  <i class="glyphicon glyphicon-triangle-left"></i>
                </li>
            </ul>

            <div class="hidden-print hidden-xs">
            <hr>
                <h3 class="filter-title-year">Year</h3>
                <ul id="totalYears" class="bar-filter filter-year finished">
                </ul>
                
                <h3 class="filter-title-port">port</h3>
                <ul id="totalPorts" class="bar-filter filter-port finished">
                  
                </ul>
              
                <h3 class="filter-title-country">country</h3>
                <ul id="totalCountrys" class="bar-filter filter-country finished">
                </ul>
              
                <h3 class="filter-title-product">product</h3>
                <ul id="totalProducts" class="bar-filter filter-product finished">
                </ul>
            </div>

          </div>

          <section class="section-related-vul hidden-xs hidden-sm affix-top" data-spy="affix" data-offset-top="43" style="display: none;">
            <h5><div style="margin-bottom: 10px;">在 &nbsp;&nbsp; <a href="https://www.seebug.org/"><img src="static/css/ksz-seebug.png" alt=""></a></div>
              相关约 <span class="count"></span> 个漏洞
            <a class="more" href="https://www.seebug.org/" target="_blank">查看全部 &gt;</a>
            </h5>
            <ul></ul>

            <div id="j-section-vul-switch" class="switch ">
              <!--相关搜索结果-->
              <i class="fa fa-chevron-right"></i><i class="fa fa-chevron-left"></i></div>
          </section>


<div class="result-list" style="min-height: 800px;">
            
<div class="result-summary">
  找到约 <strong id="totalrecords">0</strong> 条结果
  (<strong id="currpagetime">0</strong> 秒)。
</div>
            


<ul class="result device" id="detailResult">
  
</ul>

            

<div class="clearfix"></div>

            

  <ul id="paging" class="pagination">
  </ul>
          </div>

        </div>
      </div>

    </div>
  </section>

     
<div class="ksz-footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <div class="logo-wrapper">
          <a target="_blank" href="http://www.caict.ac.cn/"><img src="/static/images/caict_logo.png" alt="CAICT" style="width: 97px;height: 38px;"/></a>
        </div>
        <div class="logo-wrapper">
          <a target="_blank" href="https://www.seebug.org/"><img src="/static/images/ksz-seebug.svg" alt="Seebug" style="width: 98px;height: 31px;"/></a>
        </div>
        <div class="logo-wrapper">
          <a href="/"><img src="/static/images/neteye_small.png" alt="NetEye" style="width: 126px;height: 24px;"/></a>
        </div>
        <div class="copyright-text">
          Copyright @ 中国信息通信研究院
          
          <a class="language" href="/accounts/language/?l=en">English</a>
          
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

function callAjax(settings, callback) {
	$.ajax({
		type: settings['type'], url: settings['url'], data: settings['data'], dataType: "json",
		success: function(data){
			callback(data);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			console.log("ajax error!!! textStatus: "+ textStatus + " errorThrown: " + errorThrown);
		},
	});
}

function getParam(currPage) {
	var keys = $("#currQ").val().split(":");
	if (keys.length != 2 || keys[0] == "" || keys[1] == "") return null;
	var param = {type : keys[0], keyword : encodeURIComponent(keys[1])};
	if (currPage != undefined) param.page = currPage
	return param;
}

function requestAndRenderDetails() {
	var currPage = parseInt($(".resultPage.active").attr("page"));
	if (currPage == undefined || isNaN(currPage)) currPage = 1;
	var param = getParam(currPage);
	if (param == null) return;
	var settings = {type:'get', url: 'search/detail', data:param};
	callAjax(settings, function(data) {
		rederPaging(data);

		// 时间
		$("#currpagetime").html(data.currpagetime);
		
	    $("#detailResult").empty();
		for (var i in data.result) {
			renderDetail(data.result[i]);
		}
		
		$(".result > li").each(function() {
			dealResultLi(this);
		});
	});
}

function rederPaging(detail) {
	var currPage = parseInt(detail.currpage);
	var firstPage = parseInt((currPage-1) / 10) * 10 + 1;
	var lastPage = Math.min(firstPage + 9, parseInt(totalPage));

	var _paging = $("#paging");
	_paging.empty();
	if (firstPage > 1) {
		$('<li class="resultPage " page="'+(currPage-1)+'"><a href="javascript:void(0)">上一页</a></li>')
		.appendTo(_paging).on("click", function() {
			$(".resultPage").removeClass("active");
			$(this).addClass("active");
			requestAndRenderDetails();
		});
	}
	for (i=firstPage ; i<=lastPage; i++) {
		$('<li class="resultPage '+(currPage==i?"active":"")+'" page="'+i+'"><a href="javascript:void(0)">'+i+'</a></li>')
		.appendTo(_paging).on("click", function() {
			if ($(this).hasClass("active")) return;
			$(".resultPage").removeClass("active");
			$(this).addClass("active");
			requestAndRenderDetails();
		});
	}
	if (lastPage < parseInt(totalPage)) {
		$('<li class="resultPage " page="'+(currPage+1)+'"><a href="javascript:void(0)">下一页</a></li>')
		.appendTo(_paging).on("click", function() {
			$(".resultPage").removeClass("active");
			$(this).addClass("active");
			requestAndRenderDetails();
		});
	}
}

function renderDetail(detail) {
	var ipItem = '<h3>' +
    '<a class="ip" href="search?q=ip:%IP%">%IP%</a>' +
    '<a class="original hint--bottom" target="_blank" href="" data-hint="在新窗口打开" style="display: inline;">' +
    '<sup><i class="iconfont icon-new-window"></i></sup></a></h3>' +
    '<hr>';
    ipItem = ipItem.replace(/%IP%/g, detail.ip);
    
    var tagsItem = '';
    for(var i in detail.tags) {
    	var tagItem = '<li class="app">' +
        	'<a href="">%TAG%</a>' +
	    '</li>';
	    tagItem = tagItem.replace(/%TAG%/g, detail.tags[i].tag);
	    tagsItem += tagItem;
    }
    var articleItem = '<article class="port">' +
	    '<ul class="tags">' +
	    	tagsItem +
		'</ul>' +
		'<div class="hostname"></div>' +
	  	'<address>' +
		    '<a class="country" href="search?q=country:%22%COUNTRY%%22">' +
		      '<span class="flag %COUNTRY_FLAG%"></span>' + '%COUNTRY%' + 
		    '</a>' +
		    '<a class="city" href="search?q=city:%22%CITY%%22">' +
		      '%CITY%' +
		    '</a>' +
	  	'</address>' +
		'<div class="timestamp"><i class="iconfont icon-time"></i>' + 
	  		'<time datetime="%DATETIME%">%DATETIME%</time>' +
		'</div>' +
	'</article>';
	articleItem = articleItem.replace(/%COUNTRY%/g, detail.country).replace(/%CITY%/g, detail.city)
		.replace(/%DATETIME%/g, detail.datetime).replace(/%COUNTRY_FLAG%/g, getCountryFlag(detail.country));
	
	
	var sectionItem = '<section class="banner">' +
		'<header>' +
	    	'<i><a href="search?q=port:%PORT%&amp;t=host">%PORT%</a></i>' +
	    	'<s><a href="search?q=service:%22%SERVICE%%22&amp;t=host">%SERVICE%</a></s>' +
		'</header>' +	
		'<pre>%DESCRIPTION%</pre>' +
	  	'<p></p>' +
  	'</section>';
  	sectionItem = sectionItem.replace(/%PORT%/g, detail.port).replace(/%SERVICE%/g, detail.service).
  		replace(/%DESCRIPTION%/g, detail.description);
    
    var detailItem = '<li>' + ipItem + articleItem + sectionItem + '</li>';
    
	$("#detailResult").append(detailItem);
	
}

var totalPage = 0;

function requestAndRenderTotal() { 
	var param = getParam();
	if (param == null) return;
	var settings = {type:'get', url: 'search/sum', data:param};
	callAjax(settings, function(data) {
		renderTotal(data);

		// 总件数
		$("#totalrecords").html(data.totalrecords);
		totalPage = parseInt(data.totalpage);
		
		
	});
}
function renderTotal(detail) {
	// year
	var totalValue = 0;
	$.each(detail.result_sum.filter_year, function(idx, value) {
		totalValue += parseFloat(value.count);
	});
	$.each(detail.result_sum.filter_year, function(idx, value) {
		var row = $('<li class="clearfix"><span data-count="'+value.count+'" style="width: '+Number(parseFloat(value.count)/totalValue*100).toFixed(5)+'%;">'+value.count+'</span><a href="search?q=app%3A%22Indy%20httpd%22%20after:%222014-01-01%22%20before:%222015-01-01%22&amp;t=host">'+value.year+'</a></li>');
		$("#totalYears").append(row);
	});

	// port
	totalValue = 0;
	$.each(detail.result_sum.filter_port, function(idx, value) {
		totalValue += parseFloat(value.count);
	});
	$.each(detail.result_sum.filter_port, function(idx, value) {
		var row = $('<li class="clearfix"><span data-count="'+value.count+'" style="width: '+Number(parseFloat(value.count)/totalValue*100).toFixed(5)+'%;">'+value.count+'</span><a href="search?q=app%3A%22Indy%20httpd%22%20port:80&amp;t=host">'+value.port+'</a></li>');
		$("#totalPorts").append(row);
	});

	// country
	totalValue = 0;
	$.each(detail.result_sum.filter_country, function(idx, value) {
		totalValue += parseFloat(value.count);
	});
	$.each(detail.result_sum.filter_country, function(idx, value) {
		var row = $('<li class="clearfix show-version"><span data-count="'+value.count+'" class="right-for-menu-holder" style="width: '+Number(parseFloat(value.count)/totalValue*100).toFixed(5)+'%;">'+value.count+'<i class="expand"></i></span><a href="">'+value.country+'</a></li>');
		row.append('<div class="clearfix"></div>');
		var rowSub = $('<ul class="clearfix"></ul>').appendTo(row);

		var totalSub = 0;
		$.each(value.filter_city, function(idx, valueSub) {
			totalSub += parseFloat(valueSub.count);
		});
		$.each(value.filter_city, function(idx, valueSub) {
        	var cityRow = $('<li class="clearfix"><span data-count="'+valueSub.count+'" style="width: '+Number(parseFloat(valueSub.count)/totalSub*100).toFixed(5)+'%;">'+valueSub.count+'</span><a data-count="'+valueSub.count+'" href="">'+valueSub.city+'</a></li>');
        	rowSub.append(cityRow);
		});
		
		$("#totalCountrys").append(row);
	});

	// product
	totalValue = 0;
	$.each(detail.result_sum.filter_product, function(idx, value) {
		totalValue += parseFloat(value.count);
	});
	$.each(detail.result_sum.filter_product, function(idx, value) {
		var row = $('<li class="clearfix show-version"><span data-count="'+value.count+'" class="right-for-menu-holder" style="width: '+Number(parseFloat(value.count)/totalValue*100).toFixed(5)+'%;">'+value.count+'<i class="expand"></i></span><a href="">'+value.name+'</a></li>');
		row.append('<div class="clearfix"></div>');
		var rowSub = $('<ul class="clearfix"></ul>').appendTo(row);

		var totalSub = 0;
		$.each(value.filter_ver, function(idx, valueSub) {
			totalSub += parseFloat(valueSub.count);
		});
		$.each(value.filter_ver, function(idx, valueSub) {
        	var cityRow = $('<li class="clearfix"><span data-count="'+valueSub.count+'" style="width: '+Number(parseFloat(valueSub.count)/totalSub*100).toFixed(5)+'%;">'+valueSub.count+'</span><a data-count="'+valueSub.count+'" href="">'+valueSub.ver+'</a></li>');
        	rowSub.append(cityRow);
		});
		
		$("#totalProducts").append(row);
	});
	
}

var MAX_HEIGHT = 200;
var toggleBanner = function() {
    var $pre = $(this);
    var selection = document.getSelection();
    if ($pre.hasClass("on") && selection && selection.type === "Range") return false;
    $pre.toggleClass("on").css({
        height: $pre.hasClass("on") ? $pre.data("height") : MAX_HEIGHT
    })
};
var dealResultLi = function(element) {
	var $li = $(element);
    var $pre = $li.find("pre"),
    preHeight = $pre.outerHeight() + 30;
    if (preHeight > MAX_HEIGHT) {
        $pre.data("height", preHeight).addClass("expand").click(toggleBanner)
    }
    var port = +$li.find(".banner i").text(),
    ip = $.trim($li.find(".ip").text());
    var attached = false;
    var scheme = {
        http: [80, 81, 8081, 8080, 5060, 591, 593, 981, 2480],
        https: [443, 1311],
        ftp: [21]
    };
    for (var prefix in scheme) {
        if (!scheme.hasOwnProperty(prefix)) continue;
        if (scheme[prefix].indexOf(port) > -1) {
            $li.find(".original").attr("href", prefix + "://" + ip + ":" + port).show();
            attached = true;
            break
        }
    }
    if (!attached && $pre.text().match(/^HTTP\//)) {
        $li.find(".original").attr("href", "http://" + ip + ":" + port).show()
    }
};

$(document).ready(function() {
	requestAndRenderTotal();
	requestAndRenderDetails();
});
</script>


</body>
</html>
